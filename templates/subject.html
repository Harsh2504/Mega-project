{% extends 'base.html' %}
{% block title %}
 Subject
{% endblock title %}
{% block head %}
  <style>
    .hide {
      display: none;
    }
    .hiden {
      display: none;
    }

    .table-wrapper {
      background: var(--sidebar-color);
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 4px 15px var(--box-shad);
      overflow: hidden;
      border: 1px solid var(--table-border-color);
      margin-top: 20px;
    }

    .table-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--table-border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--main-head-color);
      margin: 0;
    }

    .table-count {
      background: var(--primary-color);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .modern-table {
      width: 100%;
      margin: 0;
      border-collapse: separate;
      border-spacing: 0;
    }

    .modern-table thead {
      background: linear-gradient(135deg, #695CFE 0%, #8b72ff 100%);
    }

    .modern-table thead th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: none;
    }

    .modern-table tbody tr {
      background: var(--sidebar-color);
      border-bottom: 1px solid var(--table-border-color);
      transition: all 0.2s ease;
    }

    .modern-table tbody tr:hover {
      background: var(--primary-color-light);
      transform: scale(1.01);
      box-shadow: 0 2px 8px var(--box-shad);
    }

    .modern-table tbody tr:last-child {
      border-bottom: none;
    }

    .modern-table tbody td,
    .modern-table tbody th {
      padding: 16px 20px;
      font-size: 14px;
      color: var(--text-color);
      border: none;
    }

    .modern-table tbody th {
      font-weight: 600;
      color: var(--main-head-color);
    }

    .edit-btn {
      background: rgba(25, 118, 210, 0.1);
      color: #1976d2;
      border: 1px solid rgba(25, 118, 210, 0.3);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .edit-btn:hover {
      background: #1976d2;
      color: white;
      border-color: #1976d2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
    }

    .delete-btn {
      background: rgba(211, 47, 47, 0.1);
      color: #d32f2f;
      border: 1px solid rgba(211, 47, 47, 0.3);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .delete-btn:hover {
      background: #d32f2f;
      color: white;
      border-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-color);
    }

    .empty-state i {
      font-size: 64px;
      color: var(--primary-color);
      opacity: 0.3;
      margin-bottom: 20px;
    }
  </style>
{% endblock head %}
{% block body %}
    

<!--main body --> 
<div id="main">
    <h2>Subject</h2>
    <p>You can add subjects data for your department here.</p>

    <button id="addButton" class="btn btn-outline-secondary" type="button" style="margin-bottom: 20px;">
      <i class="fas fa-plus-circle"></i> Add Subject
    </button><br>

    <!-- Improved Minimal Form -->
    <div id="formContainer" class="container add-block animate__animated animate__fadeInDown animate__fast" style="max-width: 480px; padding: 25px 35px; border-radius: 12px; overflow: hidden; display: none; background: var(--sidebar-color); box-shadow: 0 4px 15px var(--box-shad); border: 1px solid var(--table-border-color);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h5 style="margin: 0; color: var(--main-head-color); font-weight: 600;">
          <i class="fas fa-book" style="color: var(--primary-color);"></i> New Subject
        </h5>
        <button type="button" id="closeForm" style="background: none; border: none; font-size: 24px; color: var(--text-color); cursor: pointer; line-height: 1; padding: 0; transition: var(--tran-03);" onmouseover="this.style.color='var(--primary-color)'" onmouseout="this.style.color='var(--text-color)'">
          Ã—
        </button>
      </div>

      <form action="/add_sub" method="POST">
        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Subject Name
          </label>
          <input type="text" name="subname" placeholder="e.g., Python Programming" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
        </div>

        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Abbreviation
          </label>
          <input type="text" name="subinit" placeholder="e.g., PY" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
        </div>

        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Subject Code
          </label>
          <input type="text" name="subcd" placeholder="e.g., 201142" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
        </div>

        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Semester
          </label>
          <select name="semister" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
            {% for row in sem %}
            <option value="{{row[0]}}">{% if row[1] == 1 %}
              &#8544;
          {% elif row[1] == 2 %}
              &#8545;
          {% elif row[1] == 3 %}
              &#8546;
          {% elif row[1] == 4 %}
              &#8547;
          {% elif row[1] == 5 %}
              &#8548;
          {% elif row[1] == 6 %}
              &#8549;
          {% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 8px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Subject Type
          </label>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer; color: var(--text-color);">
              <input type="checkbox" name="th" value="Theory" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
              <span>Theory</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; color: var(--text-color);">
              <input type="checkbox" name="pra" value="Practicle" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
              <span>Practical</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer; color: var(--text-color);">
              <input type="checkbox" name="tu" value="Tutorial" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
              <span>Tutorial</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Class
          </label>
          <select name="clsnm" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
            {% for c in cls %}
            <option value="{{c[0]}}">{{c[1]}}</option>
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Department
          </label>
          <select name="department" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
            {% for row in dept %}
            <option value="{{row[0]}}">{{ row[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-outline-success" style="flex: 1; padding: 10px; font-weight: 500; border-radius: 8px;">
            <i class="fas fa-check"></i> Add Subject
          </button>
          <button type="button" id="cancelBtn" class="btn btn-outline-secondary" style="padding: 10px 20px; font-weight: 500; border-radius: 8px;">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </form>

      <div style="text-align: center; margin: 20px 0; color: var(--text-color); font-weight: 500;">OR</div>

      <form action="/up_sub" enctype="multipart/form-data" method="POST">
        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Department
          </label>
          <select name="department" required style="width: 100%; padding: 10px 14px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 14px; transition: var(--tran-03); background: var(--sidebar-color); color: var(--main-head-color);" onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px var(--primary-color-light)'" onblur="this.style.borderColor='var(--table-border-color)'; this.style.boxShadow='none'">
            {% for row in dept %}
            <option value="{{row[0]}}">{{ row[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 6px; color: var(--main-head-color); font-weight: 500; font-size: 14px;">
            Upload Excel File
          </label>
          <input type="file" name="file" id="file" required accept=".xlsx,.xls" style="width: 100%; padding: 8px; border: 1.5px solid var(--table-border-color); border-radius: 8px; font-size: 13px; background: var(--sidebar-color); color: var(--main-head-color);">
          <small style="color: var(--text-color); font-size: 12px; display: block; margin-top: 6px;"><i class="fas fa-info-circle"></i> Choose only excel file (.xlsx or .xls)</small>
        </div>

        <div style="margin-bottom: 18px; padding: 12px; background: var(--primary-color-light); border-radius: 8px; border-left: 3px solid var(--primary-color);">
          <small style="color: var(--main-head-color); font-size: 12px; display: block;">
            <i class="fas fa-exclamation-triangle" style="color: var(--primary-color);"></i> Strictly download and use the format below before uploading data
          </small>
        </div>

        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 18px;">
          <label style="color: var(--main-head-color); font-size: 13px; margin: 0;">Excel Format:</label>
          <a href="{{ url_for('download_sub_file') }}" class="btn btn-warning btn-sm" style="padding: 6px 12px; border-radius: 6px;">
            <i class="fas fa-download"></i> Download
          </a>
        </div>

        <button type="submit" class="btn btn-outline-success" style="width: 100%; padding: 10px; font-weight: 500; border-radius: 8px;">
          <i class="fas fa-file-upload"></i> Upload Subject Data
        </button>
      </form>
    </div>

    <div class="form-group" style="display: flex;">
    <label for="search-input" style="margin: 6px;">Search by:</label>
    <select id="search-filter" class="form-control" style="width: 20%; margin: 6px;">
      <option value="subject">Subject</option>
      <option value="abbreviation">Abbreviation</option>
      <option value="code">Code</option>
      {% if user == "Admin" %}
      <option value="department">Department</option>
      {% endif %}
    </select>
    
    <br>
    <input type="text" class="form-control" id="search-input" placeholder="Search" style="width: 20%; margin: 6px;">

          <!-- Add a new button for printing -->
<button type="button" class="btn btn-primary btn-sm" style="width: 50px;  margin: 6px;"onclick="printVisibleRows()">Print</button>
  </div>
    <div class="form-group" style="display: flex;">
      <label for="class-filter" style="margin: 6px;">Filter by Class:</label>
      <select id="class-filter" class="form-control" style="width: 20%; margin: 6px;">
        <option value="">All</option>
        <option value="FY">First Year</option>
        <option value="SY">Second Year</option>
        <option value="TY">Third Year</option>
      </select>
    </div>
    <div class="table-wrapper animate__animated animate__fadeInUp">
      <div class="table-header">
        <h3 class="table-title">List of Subjects</h3>
        <span class="table-count">{{ sub|length }} Subject(s)</span>
      </div>
      <table class="modern-table">
        <thead>
          <tr>
            <th style="width: 70px;">Sr No</th>
            <th style="width: 80px;">ID</th>
            <th>Subject</th>
            <th style="width: 100px;">Abbr.</th>
            <th style="width: 100px;">Code</th>
            <th style="width: 100px;">Class</th>
            <th style="width: 70px;">Sem.</th>
            <th style="width: 120px;">Type</th>
            <th>Department</th>
            <th style="width: 90px; text-align: center;">Edit</th>
            <th style="width: 90px; text-align: center;">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% if sub|length > 0 %}
            {% for s in sub %}
            <tr class="faculty-row" data-class="{{s[4]}}">
              <th>{{loop.index}}</th>
              <td>{{s[0]}}</td>
              <td>{{s[1]}}</td>
              <td>{{s[2]}}</td>
              <td>{{s[3]}}</td>
              <td>{{s[4]}}</td>
              <td>{% if s[5] == 1 %}
                &#8544;
            {% elif s[5] == 2 %}
                &#8545;
            {% elif s[5] == 3 %}
                &#8546;
            {% elif s[5] == 4 %}
                &#8547;
            {% elif s[5] == 5 %}
                &#8548;
            {% elif s[5] == 6 %}
                &#8549;
            {% endif %}
            </td>
              <td>{% if s[6] == 'y' %}
                TH
            {% endif %}
            
            {% if s[7] == 'y' %}
                {% if s[6] == 'y' %}
                    /
                {% endif %}
                PR
            {% endif %}
            
            {% if s[8] == 'y' %}
                {% if s[6] == 'y' or s[7] == 'y' %}
                    /
                {% endif %}
                TU
            {% endif %}</td>
              <td>{{s[9]}}</td>
              <td style="text-align: center;">
                <form method="post" action="/get_sub_data" style="margin: 0;">
                  <input type="hidden" name="_id" value="{{ s[0]}}">
                  <input type="hidden" name="did" value="{{s[1]}}">
                  <button type="submit" class="edit-btn">
                    <i class="fa fa-pencil"></i> Edit
                  </button>
                </form>
              </td>
              <td style="text-align: center;">
                <form action="{{ url_for('delete_sub', _id=s[0]) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this Subject?');" style="margin: 0;">
                  <button class="delete-btn" type="submit">
                    <i class="fa fa-trash"></i> Delete
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="11" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No subjects found</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            {% if category == 'success' %}
         
                <div class="alert alert-warning" style="font-size: 14px;" role="alert"> {{ message }}  </div>
   
            {% endif %}
        {% endfor %}
    {% endif %}
{% endwith %}

  </div>
<!--main body end--> 
{% endblock body %}
{% block script %}
<script>
  $(function() {
    $('#search-input').on('input', function() {
      var filter = $(this).val().toUpperCase();
      var searchFilter = $('#search-filter').val();
      $('.faculty-row').each(function() {
        var text = '';
        if (searchFilter === 'subject') {
          text = $(this).find('td:nth-child(3)').text().toUpperCase();
        } else if (searchFilter === 'abbreviation') {
          text = $(this).find('td:nth-child(4)').text().toUpperCase();
        } else if (searchFilter === 'code') {
          text = $(this).find('td:nth-child(5)').text().toUpperCase();
        } else if (searchFilter === 'department') {
          text = $(this).find('td:nth-child(9)').text().toUpperCase();
        }
        if (text.indexOf(filter) > -1) {
          $(this).removeClass('hide');
        } else {
          $(this).addClass('hide');
        }
      });
    });
  });

  $(document).ready(function() {
  // Filter table by class
  $('#class-filter').change(function() {
    var selectedClass = $(this).val();
    if (selectedClass) {
      $('.faculty-row').addClass('hiden');
      $('.faculty-row[data-class="' + selectedClass + '"]').removeClass('hiden');
    } else {
      $('.faculty-row').removeClass('hiden');
    }
  });
});


function printVisibleRows() {
  var table = document.querySelector('.modern-table');
  var visibleRows = table.querySelectorAll('tbody tr:not(.hide):not(.hiden)');


  var html = '<table class="table caption-top bord" style="color: var(--table-text-color); " >' +
    '<thead class="tab-dark">' +
      '<tr>' +
        '<th>ID</th>' +
        '<th>Subject</th>' +
        '<th>Abbrevation</th>' +
        '<th>Code</th>' +
        '<th>Class</th>' +
        '<th>Sem.</th>' +
        '<th>TH/PR/TUT</th>' +
        '<th>Department</th>' +
      '</tr>' +
    '</thead>' +
    '<tbody>' +
    '</tbody>' +
  '</table>';
  var div = document.createElement('div');
  div.innerHTML = html;
  var tbody = div.querySelector('tbody');
  for (var i = 0; i < visibleRows.length; i++) {
    var row = visibleRows[i];
    var id = row.querySelector('td:nth-child(2)').textContent;
    var subject = row.querySelector('td:nth-child(3)').textContent;
    var abbrevation = row.querySelector('td:nth-child(4)').textContent;
    var code = row.querySelector('td:nth-child(5)').textContent;
    var class1 = row.querySelector('td:nth-child(6)').textContent;
    var sem = row.querySelector('td:nth-child(7)').textContent;
    var thprtut = row.querySelector('td:nth-child(8)').textContent;
    var department = row.querySelector('td:nth-child(9)').textContent;
    var newRow = document.createElement('tr');
    newRow.innerHTML = '<td>' + id + '</td>' +
      '<td>' + subject + '</td>' +
      '<td>' + abbrevation + '</td>' +
      '<td>' + code + '</td>' +
      '<td>' + class1 + '</td>' +
      '<td>' + sem + '</td>' +
      '<td>' + thprtut + '</td>' +
      '<td>' + department + '</td>';
    tbody.appendChild(newRow);
  }
  var printWindow = window.open('/print1?table_html=' + encodeURIComponent(div.innerHTML), 'Print');
  printWindow.focus();
  printWindow.print();
}

  </script>
{% endblock script %}